<script>
import * as Blockly from 'blockly';
import { javascriptGenerator } from 'blockly/javascript';

export const category = {
  label: 'ìŠ¤íƒ€ì¼',
  color: '#ab47bc',
  icon: 'ğŸ¨'
};

export const toolbox = `
<xml>
  <block type="style_tag"></block>
  <label text="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"></label>
  <block type="style_font_text_style"></block>
  <block type="style_size"></block>
  <block type="style_opacity"></block>
  <block type="style_text_align"></block>
  <block type="style_border_radius"></block>
  <label text="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"></label>
  <block type="style_padding"></block>
  <block type="style_margin"></block> </xml>
`;

export const defineBlocks = () => {
  // 1. ìŠ¤íƒ€ì¼ ì ìš© ëŒ€ìƒ (Wrapper)
  Blockly.Blocks['style_tag'] = {
    init: function() {
      this.appendDummyInput()
          .appendField("ğŸ¨ ìŠ¤íƒ€ì¼ ì ìš© ëŒ€ìƒ")
          .appendField(new Blockly.FieldTextInput(".container"), "SELECTOR");
      this.appendStatementInput("BODY")
          .setCheck(null)
          .appendField("ì†ì„±ë“¤");
      this.setPreviousStatement(true);
      this.setNextStatement(true);
      this.setColour('#ab47bc');
    }
  };

  // 2. ê¸€ì ì„¤ì •
  Blockly.Blocks['style_font_text_style'] = {
    init() {
      this.appendDummyInput()
          .appendField("ğŸ”  ê¸€ì ì„¤ì •")
          .appendField("í¬ê¸°").appendField(new Blockly.FieldTextInput("20"), "SIZE").appendField("px ,")
          .appendField("ë‘ê»˜").appendField(new Blockly.FieldDropdown([["ë³´í†µ", "normal"], ["ì§„í•˜ê²Œ", "bold"]]), "WEIGHT");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };

  // 3. í¬ê¸° ì„¤ì •
  Blockly.Blocks['style_size'] = {
    init() {
      this.appendDummyInput()
          .appendField("ğŸ“ í¬ê¸° ë„ˆë¹„").appendField(new Blockly.FieldTextInput("100%"), "WIDTH")
          .appendField("ë†’ì´").appendField(new Blockly.FieldTextInput("auto"), "HEIGHT");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };

  // 4. íˆ¬ëª…ë„
  Blockly.Blocks['style_opacity'] = {
    init: function() {
      this.appendDummyInput()
          .appendField("ğŸ íˆ¬ëª…ë„").appendField(new Blockly.FieldNumber(100, 0, 100), "OPACITY").appendField("%");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };

  // 5. ì •ë ¬
  Blockly.Blocks['style_text_align'] = {
    init() {
      this.appendDummyInput()
          .appendField("ğŸ“ ì •ë ¬").appendField(new Blockly.FieldDropdown([["ì™¼ìª½", "left"], ["ê°€ìš´ë°", "center"], ["ì˜¤ë¥¸ìª½", "right"]]), "ALIGN");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };

  // 6. ë‘¥ê·¼ ëª¨ì„œë¦¬
  Blockly.Blocks['style_border_radius'] = {
    init() {
      this.appendDummyInput()
          .appendField("ğŸ”˜ ë‘¥ê·¼ ëª¨ì„œë¦¬").appendField(new Blockly.FieldTextInput("10"), "RADIUS").appendField("px");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };

  // 7. ì•ˆìª½ ì—¬ë°± (Padding)
  Blockly.Blocks['style_padding'] = {
    init() {
      this.appendDummyInput()
          .appendField("ğŸ“¦ ì•ˆìª½ ì—¬ë°±")
          .appendField(new Blockly.FieldDropdown([
            ["ì „ì²´", "padding"], 
            ["ìœ„", "padding-top"], 
            ["ì•„ë˜", "padding-bottom"],
            ["ì™¼ìª½", "padding-left"],
            ["ì˜¤ë¥¸ìª½", "padding-right"]
          ]), "SIDE")
          .appendField(new Blockly.FieldTextInput("10"), "VAL").appendField("px");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };

  // 8. âœ… [ëˆ„ë½ë˜ì—ˆë˜ ë¶€ë¶„ ì¶”ê°€] ë°”ê¹¥ ì—¬ë°± (Margin)
  Blockly.Blocks['style_margin'] = {
    init() {
      this.appendDummyInput()
          .appendField("â†”ï¸ ë°”ê¹¥ ì—¬ë°±")
          .appendField(new Blockly.FieldDropdown([
            ["ì „ì²´", "margin"], 
            ["ìœ„", "margin-top"], 
            ["ì•„ë˜", "margin-bottom"],
            ["ì™¼ìª½", "margin-left"],
            ["ì˜¤ë¥¸ìª½", "margin-right"]
          ]), "SIDE")
          .appendField(new Blockly.FieldTextInput("10"), "VAL").appendField("px");
      this.setPreviousStatement(true); this.setNextStatement(true); this.setColour('#ab47bc');
    }
  };
};

// ==================== ì œë„ˆë ˆì´í„° ====================

javascriptGenerator.forBlock['style_tag'] = function(block, generator) {
  const selector = block.getFieldValue('SELECTOR') || '.container';
  const bodyCode = generator.statementToCode(block, 'BODY');
  return `<style>\n  ${selector} {\n    ${bodyCode.trim()}\n  }\n</style>\n`;
};

javascriptGenerator.forBlock['style_font_text_style'] = (block) => `font-size: ${block.getFieldValue('SIZE')}px; font-weight: ${block.getFieldValue('WEIGHT')};\n`;

javascriptGenerator.forBlock['style_size'] = (block) => {
  const w = block.getFieldValue('WIDTH');
  const h = block.getFieldValue('HEIGHT');
  let code = '';
  if (w && w !== 'auto') code += `width: ${/^\d+$/.test(w) ? w + 'px' : w}; `;
  if (h && h !== 'auto') code += `height: ${/^\d+$/.test(h) ? h + 'px' : h}; `;
  return code + '\n';
};

javascriptGenerator.forBlock['style_opacity'] = (block) => `opacity: ${block.getFieldValue('OPACITY') / 100};\n`;

javascriptGenerator.forBlock['style_text_align'] = (block) => `text-align: ${block.getFieldValue('ALIGN')};\n`;

javascriptGenerator.forBlock['style_border_radius'] = (block) => `border-radius: ${block.getFieldValue('RADIUS')}px;\n`;

javascriptGenerator.forBlock['style_padding'] = (block) => `${block.getFieldValue('SIDE')}: ${block.getFieldValue('VAL')}px;\n`;

// âœ… Margin ì œë„ˆë ˆì´í„° (ì´ë¯¸ ìˆì—ˆì§€ë§Œ ì •ì˜ì™€ ì§ì„ ë§ì¶¤)
javascriptGenerator.forBlock['style_margin'] = (block) => `${block.getFieldValue('SIDE')}: ${block.getFieldValue('VAL')}px;\n`;
</script>